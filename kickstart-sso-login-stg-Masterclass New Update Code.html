<script>
    document.addEventListener("webNearLoaded", function () {
        const slideFlid = document.querySelector(".webinar_registration_for_masterclass .slots_container .slot_fild");
        slideFlid.innerHTML = "";
        webinarSlots.slice(0, 6).forEach(function (slot, index) {
            let createWebniarSlot = document.createElement("label");
            createWebniarSlot.classList.add("slot");
            const startTime = new Date(slot.start_time);
            const formattedStartTime = startTime.toLocaleTimeString("en-US", {
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
            });

            let slotInner = `
                <input type="radio" 
                name="masterclass_slot" 
                class="masterclass_slot_radio"
                value="${slot.start_time}"
                data-endtime="${slot.end_time}" 
                data-invitee_starttime="${slot.invitee_start_time}" 
                data-invitee_endtime="${slot.invitee_end_time}" 
                data-name="${slot.start_time}" 
                data-webinar_lead_type="${slot.webinar_lead_type}" 
                ${index === 0 ? "checked" : ""}
                slot-index="${index}"
                data-show-text="${startTime.getDate()} ${startTime.toLocaleDateString("en-US", { weekday: "long" })}, ${formattedStartTime}" >
                <div class="time_slot_wrapper">
                    <div class="masterclass_day">${startTime.toLocaleDateString("en-US", { weekday: "long" }).slice(0, 3).toUpperCase()}</div>
                    <div class="masterclass_date">${startTime.getDate()}</div>
                    <hr>
                    <div class="masterclass_time">${formattedStartTime}</div>
                </div>

        `;

            if (index === 0) {
                slotInner += `
                <div class="masterclass_timer_alart" alart_type="warning">
                    Filling fast
                </div>
            `;
            } else if (slot.weekday === "Saturday") {
                slotInner += `
                <div class="masterclass_timer_alart" alart_type="danger">
                    Almost full
                </div>
            `;
            }

            createWebniarSlot.innerHTML = slotInner;
            slideFlid.appendChild(createWebniarSlot);
        });
    });

    function errorHider({ selector = null } = {}) {
        if (!selector) return;
        let fildType = selector.type;
        let inputEvents = [];
        if (fildType === "text" || fildType === "email" || fildType === "tel" || fildType === "textarea") {
            inputEvents = ['input', 'focus'];
        } else if (fildType === "radio" || fildType === "checkbox") {
            inputEvents = ['change'];
        } else if (fildType === "select-one") {
            inputEvents = ['change', 'focus'];
        } else {
            return;
        }
        inputEvents.forEach(function (eventName) {
            selector.addEventListener(eventName, function () {
                selector.closest('[err_status]').setAttribute('err_status', false);
            });
        });
    }

    function errorStatusCheck({ selector = null, checkRegx = "", message = "" } = {}) {
        if (!selector) return;
        let getValue = selector.value.trim();
        if (!getValue || (checkRegx instanceof RegExp && !checkRegx.test(getValue))) {
            selector.closest('[err_status]').setAttribute('err_status', true);
            return true;
        }
        return false;
    }

    window.addEventListener("DOMContentLoaded", function () {
        const getFormContainer = document.querySelector(".webinar_registration_for_masterclass");

        // 1st Step
        const nameFild = getFormContainer?.querySelector('#Full-Name-Masterclass');
        const emailFild = getFormContainer?.querySelector('#Email-Address-Masterclass');

        // 2nd Step
        const phoneFild = getFormContainer?.querySelector('#webinar_pnumber-Masterclass');
        const expFild = getFormContainer?.querySelector('#gql_experience-Masterclass');
        const domainFild = getFormContainer?.querySelector('#gql_domain_role-Masterclass');
        const gqlGoalFild = getFormContainer?.querySelector('#gql_goal_fit-Masterclass');
        const gqlSelectFild = getFormContainer?.querySelector('#gql_int_select-Masterclass');

        const phoneFildTell = window.intlTelInput(phoneFild, {
            initialCountry: "auto",
            geoIpLookup: function (callback) {
                fetch("https://ipinfo.io", { headers: { Accept: "application/json" } })
                    .then((resp) => resp.json())
                    .then((resp) => {
                        callback(resp.country);
                    })
                    .catch((error) => {
                        console.error("Error in geoIpLookup", error);
                        callback("in");
                    });
            },
            utilsScript:
                "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        // error Hider add
        [nameFild, emailFild, phoneFild, expFild, domainFild, gqlGoalFild, gqlSelectFild].forEach(eachItem => errorHider({ selector: eachItem }));


        // Handeling functions
        function actionStep1(e) {
            e.preventDefault();
            getFormContainer.setAttribute('loader_status', true);
            let errorStatus = false;
            if (errorStatusCheck({ selector: nameFild, checkRegx: name_regex })) errorStatus = true;
            if (errorStatusCheck({ selector: emailFild, checkRegx: email_regex })) errorStatus = true;

            if (!errorStatus) {
                let fullname = nameFild.value.trim();
                if (fullname.substring(0, fullname.indexOf(" ")) == "") {
                    webNearInfo.firstName = fullname.substring(fullname.indexOf(" ") + 1);
                    webNearInfo.lastName = fullname.substring(fullname.indexOf(" ") + 1);
                } else if (fullname.substring(fullname.indexOf(" ") + 1) == "") {
                    webNearInfo.firstName = fullname.substring(0, fullname.indexOf(" "));
                    webNearInfo.lastName = fullname.substring(0, fullname.indexOf(" "));
                } else {
                    webNearInfo.firstName = fullname.substring(0, fullname.indexOf(" "));
                    webNearInfo.lastName = fullname.substring(fullname.indexOf(" ") + 1);
                }
                sendZap({ zapEndPoint: '27cwi2a' }).then(() => {
                    getFormContainer.setAttribute('ac_step', '2');
                    getFormContainer.setAttribute('loader_status', false);
                }).catch(() => getFormContainer.setAttribute('loader_status', false));
            } else {
                getFormContainer.setAttribute('loader_status', false); s
            }
        }

        function actionStep2(e) {
            e.preventDefault();
            getFormContainer.setAttribute('loader_status', true);
            let errorStatus = false;
            if (errorStatusCheck({ selector: phoneFild, checkRegx: phone_regex })) errorStatus = true;
            if (errorStatusCheck({ selector: expFild })) errorStatus = true;
            if (errorStatusCheck({ selector: domainFild })) errorStatus = true;

            if (v_country != 'India') {
                if (errorStatusCheck({ selector: gqlGoalFild })) errorStatus = true;
            } else {
                if (errorStatusCheck({ selector: gqlSelectFild })) errorStatus = true;
            }

            if (!errorStatus) {
                webNearInfo.fPhoneNumber = "";
                if (typeof intlTelInputUtils == "undefined") {
                    try {
                        webNearInfo.fPhoneNumber = `+${phoneFildTell.getSelectedCountryData().dialCode || ""}${phoneFild?.value}`;
                    } catch (error) {
                        webNearInfo.fPhoneNumber = phoneFild?.value;
                    }
                } else {
                    webNearInfo.fPhoneNumber = phoneFildTell.getNumber(intlTelInputUtils.numberFormat.E164);
                }

                let extraFilds = {
                    "Work Experience": expFild.value.trim(),
                    "Role Domain": domainFild.value.trim(),
                    "Current Goal": gqlGoalFild.value.trim(),
                    "Interview Start Time": gqlSelectFild.value.trim(),
                }

                sendZap({ zapEndPoint: '2eumu4v', extraFilds }).then(() => {
                    getFormContainer.setAttribute('ac_step', '3');
                    getFormContainer.setAttribute('loader_status', false);
                }).catch(() => getFormContainer.setAttribute('loader_status', false));
            } else {
                getFormContainer.setAttribute('loader_status', false);
            }
        }

        function actionStep3() {
            getFormContainer.setAttribute('loader_status', true);
            document.querySelector('.careear_season_time').innerHTML = getFormContainer.querySelector('.slot_fild input[type="radio"]:checked').getAttribute('data-show-text');
            sendZap({ zapEndPoint: '34cq9f8' }).then(() => {
                getFormContainer.setAttribute('ac_step', 'complete');
                getFormContainer.setAttribute('loader_status', false);
            }).catch(() => getFormContainer.setAttribute('loader_status', false));
        }

        getFormContainer.querySelector(".step_1_btn").addEventListener("click", actionStep1);
        getFormContainer.querySelector(".step_2_btn").addEventListener("click", actionStep2);
        getFormContainer.querySelector(".step_3_btn").addEventListener("click", actionStep3);

        async function sendZap({ endpoint = "", zapEndPoint = "", extraFilds = {} } = {}) {
            if (!endpoint && zapEndPoint) {
                // TODO: Move Zapier webhook ID to server-side environment variable for security
                endpoint = `https://hooks.zapier.com/hooks/catch/YOUR_ZAPIER_ID/${zapEndPoint}`; // Replace with secure ID from backend
            } else if (!endpoint && !zapEndPoint) {
                return;
            }

            let getCheckWebnear = getFormContainer.querySelector('.slot_fild input[type="radio"]:checked');

            webNearInfo.eventStartTime = getCheckWebnear?.value;
            webNearInfo.eventEndTime = getCheckWebnear.getAttribute("data-endtime");
            webNearInfo.inviteStartTime = getCheckWebnear.getAttribute("data-invitee_starttime");
            webNearInfo.inviteEndTime = getCheckWebnear.getAttribute("data-invitee_endtime");

            let formData = {
                "First Name": webNearInfo.firstName,
                "Last Name": webNearInfo.lastName,
                "Email Address": emailFild.value,
                ByeCalendlyType: webNearInfo.bye_calendly_type,
                "webinar-type": webinarType || webNearInfo.webinar_type,
                "Webinar Lead Type": webinarType || webNearInfo.webinar_lead_type,
                utm_source: webNearInfo.utm_source,
                utm_medium: webNearInfo.utm_medium,
                utm_campaign: webNearInfo.utm_campaign,
                utm_content: webNearInfo.utm_content,
                utm_adset: webNearInfo.utm_adset,
                utm_term: webNearInfo.utm_term,

                City: webNearInfo.wr__city,
                Device: webNearInfo.wr__device,
                Referrer: webNearInfo.wr__referrer,
                Region: webNearInfo.wr__region,

                gclid: webNearInfo.gclid,
                msclkid: webNearInfo.msclkid,
                fbclid: webNearInfo.fbclid,
                fbpId: webNearInfo.fbpId,
                fbcId: webNearInfo.fbcId,
                user_agent: webNearInfo.userAgent,
                user_id: webNearInfo.user_id,
                li_fat_id: webNearInfo.li_fat_id,

                cta_page_url: webNearInfo.cta_page_url,
                landing_page_url: webNearInfo.l_page_url,
                event_name: webNearInfo.eventname,
                masterclass_instructor_details: instructorDetails,
                lead_magnet: "MASTERCLASS_LIVE",
                user_timezone: webNearInfo.user_timezone,
                page_url: webNearInfo.page_url,
                site_url: webNearInfo.site_url,
                v_country: webNearInfo.v_country,
                salesforce_uuid: webNearInfo.salesforce_uuid,
                phone_number_full: webNearInfo.fPhoneNumber,
                is_exit_intent_popup: webNearInfo.is_exit_intent_popup,
                irclickid: webNearInfo.irclickid,

                "Event Start Time": webNearInfo.eventStartTime,
                "Event End Time": webNearInfo.eventEndTime,
                "Invitee Start Time": webNearInfo.inviteStartTime,
                "Invitee End Time": webNearInfo.inviteEndTime,
                ...(window.updateZapPayload || {}),
            };

            formData = { ...formData, ...extraFilds };

            // Validate payload before sending
            if (!formData || Object.keys(formData).length === 0 || JSON.stringify(formData) === "{}") {
                throw new Error("Zapier webhook payload is empty");
            }

            let options = {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
            };
            try {
                const sendData = await fetch(endpoint, options);
                return sendData;
            } catch (err) {
                console.error("P0: The Zapier Webhook Failed.", err);
                alert("Something is wrong");
            }
        }


        function reliventSlotLoad() {
            const allSlots = {};
            return async function (currentWebinarType) {
                webinarType = currentWebinarType;
                if (allSlots[currentWebinarType]) {
                    webinarSlots = allSlots[currentWebinarType];
                    return webinarSlots;
                }
                let v_country_code = v_country !== "India" ? "USA" : "IND";
                let api_url = `https://uplevel.interviewkickstart.com/api/webinar-slot/upcoming-slots/?country=${v_country_code}&program=Backend&timezone=${v_timezone?.replace("+", "%2B")}&type=${currentWebinarType}`;
                const option = {
                    method: "GET",
                    headers: {
                        // TODO: Move API key to server-side environment variable for security
                        Authorization: "YOUR_API_TOKEN", // Replace with secure token from backend
                    },
                };
                const response = await fetch(api_url, option);
                const data = await response.json();
                const resobj = data.map((item) => ({ ...item, webinar_lead_type: webinarType, }));
                allSlots[currentWebinarType] = resobj;
                webinarSlots = resobj;
                return webinarSlots;
            };
        }

        let reliventSlotLoadFunc = reliventSlotLoad();

        let defafultWebinarType = webinarType;
        let defafultEventName = eventName;

        function slot_change_fun() {
            if (v_country === "India") eventName = "AI Edge: Rethink Interview-Readiness in 2025";

            if (this.value && v_country !== "India") {
                webinarType = this.selectedOptions[0].getAttribute('webinartype') || defafultWebinarType;
                document.body.setAttribute("webinarType", webinarType);
                switch (webinarType) {
                    case "SWITCH_UP":
                        eventName = "Uplevel Your Career with AI/ML/Gen AI";
                        break;
                    case "Agentic_AI":
                        eventName = "Uplevel your career with Agentic AI";
                        break;
                    default:
                        eventName = "How to nail your next technical interview";
                        break;
                }
                reliventSlotLoadFunc(webinarType).then((x) => {
                    document.dispatchEvent(webNearLoadedEv);
                });
            }
        }

        document.querySelector("#gql_goal_fit-Masterclass").addEventListener('change', slot_change_fun);

        if (v_country) {
            document.body.setAttribute("country", v_country);
        } else {
            document.addEventListener('countryLoaded', function () {
                document.body.setAttribute("country", v_country);
            })
        }
    })

    ////////////////////////////////////////////////////////////rakib////////////////////////////////////////////////////////////////////////////

    // socaial login intigration
    /* ---------- Config ---------- */
    const BASE_URL = "https://qa-ik-auth-service.interviewkickstart.com";
    const LOGIN_EXPIRY_DAYS = 90;
    const crossSubDomain = ".wpcomstaging.com";
    const sameSite = "none";

    /* ---------- Session helpers ---------- */
    const setLoginSession = (user) => {
        const expiry = Date.now() + LOGIN_EXPIRY_DAYS * 24 * 60 * 60 * 1000;

        localStorage.setItem("sso_logged_in", "true");
        localStorage.setItem("sso_expiry", expiry);

        // store user info safely
        localStorage.setItem("sso_name", user.name || "");
        localStorage.setItem("sso_email", user.email || "");
    };

    const isSessionValid = () => {
        const loggedIn = localStorage.getItem("sso_logged_in") === "true";
        const expiry = Number(localStorage.getItem("sso_expiry"));
        return loggedIn && expiry && Date.now() < expiry;
    };

    const clearSession = () => {
        localStorage.removeItem("sso_logged_in");
        localStorage.removeItem("sso_expiry");
        localStorage.removeItem("sso_name");
        localStorage.removeItem("sso_email");
    };

    /* ---------- Initiate SSO ---------- */
    const initiateSSO = async (provider) => {
        try {
            const redirect_uri = window.location.href;

            const res = await fetch(`${BASE_URL}/auth/sso/${provider}/initiate/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ redirect_uri }),
                credentials: "include"
            });

            if (!res.ok) throw new Error(`SSO failed: ${res.status}`);

            const data = await res.json();

            if (data.authorization_url) {
                // Redirect to SSO provider
                window.location.href = data.authorization_url;
            }

        } catch (err) {
            console.error("SSO error:", err);
        }
    };

    //social login integration end

    //second step data ///////////////////////////////////////////////////////////////////////////////////

    function setCookie(name, value, days) {
        const maxAge = days * 24 * 60 * 60;
        document.cookie = `${name}=${encodeURIComponent(value)}; max-age=${maxAge}; path=/; domain=${crossSubDomain}; secure; samesite=${sameSite}`;
    }

    function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : null;
    }

    document.querySelector(".step_2_btn")?.addEventListener("click", () => {

        const data = {
            name: document.getElementById("Full-Name-Masterclass")?.value || "",
            email: document.getElementById("Email-Address-Masterclass")?.value || "",
            phone: document.getElementById("webinar_pnumber-Masterclass")?.value || "",
            experience: document.getElementById("gql_experience-Masterclass")?.value || "",
            domain: document.getElementById("gql_domain_role-Masterclass")?.value || "",
            goal: document.getElementById("gql_goal_fit-Masterclass")?.value || "",
            interview: document.getElementById("gql_int_select-Masterclass")?.value || ""
        };

        setCookie("mc_user_data", JSON.stringify(data), LOGIN_EXPIRY_DAYS);
    });

    /* ---------- On page load ---------- */

    let user = null;

    document.addEventListener("DOMContentLoaded", () => {
        // --- Parse URL hash after redirect from SSO ---
        const hash = new URLSearchParams(window.location.hash.substring(1));

        const accessToken = hash.get("access_token");
        const refreshToken = hash.get("refresh_token");

        const name = hash.get("full_name") || "";
        const email = hash.get("email") || "";

        if (accessToken && refreshToken) {
            // store tokens in cookies
            document.cookie = `refresh_token=${refreshToken}; max-age=${60 * 60 * 24 * LOGIN_EXPIRY_DAYS}; domain=${crossSubDomain}; path=/;  secure; samesite=${sameSite}`;
            document.cookie = `access_token=${accessToken}; max-age=900; domain=${crossSubDomain}; path=/;  secure; samesite=${sameSite}`;

            // store session + user info
            setLoginSession({ name, email });

            // clean URL (remove hash)
            window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
        }

        // --- Auto-fill forms and hide SSO buttons ---
        if (isSessionValid()) {
            const storedName = localStorage.getItem("sso_name");
            const storedEmail = localStorage.getItem("sso_email");

            const nameInput = document.querySelector('input[name="name"]');
            const emailInput = document.querySelector('input[name="email"]');

            if (storedName && nameInput) {
                nameInput.value = storedName;
                nameInput.dispatchEvent(new Event("input", { bubbles: true }));
            }

            if (storedEmail && emailInput) {
                emailInput.value = storedEmail;
                emailInput.dispatchEvent(new Event("input", { bubbles: true }));
            }

            // hide SSO buttons
            const ssoButtons = document.getElementById("sso-buttons");
            if (ssoButtons) {
                ssoButtons.style.display = "none";
            }
        } else {
            clearSession(); // session expired
        }

        const cookieData = getCookie("mc_user_data");
        if (!cookieData) return;

        try {
            user = JSON.parse(cookieData);
        } catch {
            console.warn("Invalid mc_user_data cookie");
            return;
        }


        // Hide both forms
        const hideFormsInterval = setInterval(() => {
            const form1 = document.querySelector(".fr_stage_1");
            const form2 = document.querySelector(".fr_stage_2");

            if (form1 && form2) {
                form1.style.display = "none";
                form2.style.display = "none";
                clearInterval(hideFormsInterval);
            }
        }, 100);


        // Create welcome UI
        const welcome = document.createElement("div");
        welcome.className = "welcome_back";
        welcome.innerHTML = `
    <h3>Welcome back, ${user.name} </h3>
    <button class="fr_btn auto_submit_btn">
      Reserve Your Free Spot Now
    </button>
  `;

        document.querySelector(".form_steps")?.prepend(welcome);

    });

    let autoSubmitted = false;
    document.addEventListener("click", e => {

        const ssoProvider =
            e.target.closest(".google_btn") && "google" ||
            e.target.closest(".meta_btn") && "meta" ||
            e.target.closest(".linkedin_btn") && "linkedin";

        if (ssoProvider) {
            initiateSSO(ssoProvider);
            return;
        }


        if (!e.target.closest(".auto_submit_btn") || autoSubmitted) return;
        if (!user) return;

        // Auto-fill stage 1
        document.getElementById("Full-Name-Masterclass").value = user.name;
        document.getElementById("Email-Address-Masterclass").value = user.email;

        // Auto-fill stage 2
        document.getElementById("webinar_pnumber-Masterclass").value = user.phone;
        document.getElementById("gql_experience-Masterclass").value = user.experience;
        document.getElementById("gql_domain_role-Masterclass").value = user.domain;
        document.getElementById("gql_goal_fit-Masterclass").value = user.goal;
        document.getElementById("gql_int_select-Masterclass").value = user.interview;

        // Show forms (if required by submit logic)
        document.querySelector(".fr_stage_1").style.display = "block";
        document.querySelector(".fr_stage_2").style.display = "block";

        // Trigger submit (adjust if you use custom submit)
        autoSubmitted = true;
        document.querySelector(".step_2_btn")?.click();
    });


</script>